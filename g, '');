      
      const parsed = JSON.parse(jsonStr);
      const { title, category, score, scoreBreakdown, missingKeywords, formatIssues, analysis, metricSuggestions } = parsed;
      
      await ctx.runMutation(internal.resumes.updateResumeMetadata, {
        id: args.id,
        title,
        category,
        analysis,
        score,
        scoreBreakdown,
        missingKeywords,
        formatIssues,
        metricSuggestions,
        status: "completed",
      });
      
      console.log(`[AI Analysis] Successfully completed analysis for resume ${args.id}, score: ${score}`);
    } catch (error) {
      console.error("Error analyzing resume:", error);
      await ctx.runMutation(internal.resumes.updateResumeMetadata, {
        id: args.id,
        title: "Resume",
        category: "Uncategorized",
        analysis: "AI analysis failed. Please try again.",
        score: 0,
        scoreBreakdown: { keywords: 0, format: 0, completeness: 0 },
        status: "failed",
      });
    }
  },
});

// ... keep existing code (rewriteResume, optimizeLinkedIn, chat functions)
