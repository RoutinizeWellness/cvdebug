    
    // Remove any leading non-JSON characters (sometimes AI adds "Here is the JSON:")
    const firstBrace = cleaned.indexOf('{');
    if (firstBrace > 0) {
        cleaned = cleaned.substring(firstBrace);
    }
    const lastBrace = cleaned.lastIndexOf('}');
    if (lastBrace !== -1 && lastBrace < cleaned.length - 1) {
        cleaned = cleaned.substring(0, lastBrace + 1);
    }

    // Try parsing the cleaned string directly
    try {
      const parsed = JSON.parse(cleaned);
      if (parsed && typeof parsed === 'object') {
        return parsed;
      }
    } catch (err) {
      console.log("[extractJSON] Failed to parse cleaned content, no JSON found");
    }

    // Strategy 3: Aggressive cleanup for common AI artifacts
    try {
        // sometimes quotes are escaped improperly or there are trailing commas
        const aggressiveClean = cleaned
            .replace(/,\s*}/g, '}') // remove trailing commas
            .replace(/,\s*]/g, ']')
            .replace(/\\"/g, '"'); // fix double escaped quotes if any
            
        const parsed = JSON.parse(aggressiveClean);
        if (parsed && typeof parsed === 'object') return parsed;
    } catch (e) {
        // ignore
    }

    // If all attempts fail, return null or throw error
    console.error("[extractJSON] All parsing strategies failed");
    return null;
  } catch (err) {
    console.error("[extractJSON] Unexpected error:", err);
    return null;
  }
}
