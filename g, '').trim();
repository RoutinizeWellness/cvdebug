  
  // 1. Try to find the JSON object using brace counting (most robust)
  const jsonStart = cleanContent.indexOf('{');
  if (jsonStart === -1) {
    console.error("AI Response not JSON (no opening brace):", content);
    throw new Error("Invalid JSON response from AI - No JSON object found");
  }

  let braceCount = 0;
  let inString = false;
  let escape = false;
  let jsonEnd = -1;

  for (let i = jsonStart; i < cleanContent.length; i++) {
    const char = cleanContent[i];
    
    if (inString) {
      if (escape) {
        escape = false;
      } else if (char === '\\') {
        escape = true;
      } else if (char === '"') {
        inString = false;
      }
    } else {
      if (char === '"') {
        inString = true;
      } else if (char === '{') {
        braceCount++;
      } else if (char === '}') {
        braceCount--;
        if (braceCount === 0) {
          jsonEnd = i;
          break;
        }
      }
    }
  }

  let jsonStr = "";
  
  if (jsonEnd !== -1) {
    jsonStr = cleanContent.substring(jsonStart, jsonEnd + 1);
  } else {
    // Fallback: Try to use the last closing brace if counting failed (e.g. malformed)
    const lastBrace = cleanContent.lastIndexOf('}');
    if (lastBrace !== -1) {
      jsonStr = cleanContent.substring(jsonStart, lastBrace + 1);
    } else {
      // Last resort: try to parse the whole thing from start
      jsonStr = cleanContent.substring(jsonStart);
    }
  }
  
  try {
    return JSON.parse(jsonStr);
  } catch (e) {
    console.error("JSON Parse Error:", e);
    console.error("Faulty JSON String:", jsonStr);
    
    // Regex fallback for desperate times
    try {
      const match = content.match(/\{[\s\S]*\}/);
      if (match) {
        return JSON.parse(match[0]);
      }
    } catch (e2) {
      // ignore
    }

    throw new Error("Failed to parse AI response as JSON");
  }
}
