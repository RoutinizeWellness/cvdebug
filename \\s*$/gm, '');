    
    const jsonStart = cleaned.indexOf('{');
    const jsonEnd = cleaned.lastIndexOf('}');
    
    if (jsonStart === -1 || jsonEnd === -1) {
      console.error("[extractJSON] No JSON object found in content");
      throw new Error("No JSON object found in AI response");
    }
    
    const jsonStr = cleaned.substring(jsonStart, jsonEnd + 1);
    
    const finalJson = jsonStr
      .replace(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '')
      .replace(/\\n\\s*\\/\\/.*/g, '')
      .trim();
    
    const parsed = JSON.parse(finalJson);
    console.log("[extractJSON] Successfully parsed JSON");
    return parsed;
    
  } catch (error: any) {
    console.error("[extractJSON] Failed to parse JSON:", error.message);
    console.error("[extractJSON] Content preview:", content.substring(0, 500));
    throw new Error(`Failed to parse AI response as JSON: ${error.message}`);
  }
}
