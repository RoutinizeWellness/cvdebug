// Strategy 1: Remove markdown code blocks with multiple patterns
cleaned = cleaned.replace(/^
  \s*```(?:\w+)?\s*[\s\S]*?```\s*$/gm, '');

// Strategy 2: Find JSON object boundaries if wrapped in text
const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
if (jsonMatch) {
  cleaned = jsonMatch[0];
  console.log("[extractJSON] Extracted JSON from boundaries");
}

// Strategy 3: Remove common prefixes/suffixes
cleaned = cleaned.replace(/^[^{]*/, ''); // Remove everything before first {
cleaned = cleaned.replace(/[^}]*$/, ''); // Remove everything after last }

// Strategy 4: Clean up control characters and invalid JSON characters
cleaned = cleaned.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
cleaned = cleaned.replace(/\\n/g, '\n');
cleaned = cleaned.replace(/\\"/g, '"');

cleaned = cleaned.trim();

console.log("[extractJSON] Cleaned content length:", cleaned.length);
console.log("[extractJSON] First 200 chars of cleaned:", cleaned.substring(0, 200));

// Try to parse
const jsonObject = JSON.parse(cleaned);
console.log("[extractJSON] Successfully parsed JSON");
return jsonObject;
} catch (error: any) {
  console.error("[extractJSON] Failed to parse JSON:", error.message);
  console.error("[extractJSON] Content that failed:", content.substring(0, 500));
  
  // Last resort: Try to extract just the JSON part more aggressively
  try {
    const match = content.match(/\{(?:[^{}]|(?:\{[^{}]*\}))*\}/);
    if (match) {
      console.log("[extractJSON] Attempting aggressive extraction");
      return JSON.parse(match[0]);
    }
  } catch (e) {
    console.error("[extractJSON] Aggressive extraction also failed");
  }
  
  throw new Error(`JSON parsing failed: ${error.message}`);
}
}

// Fallback analysis function using rule-based ML approach
export function generateFallbackAnalysis(ocrText: string, jobDescription?: string): any {
  console.log("[Fallback Analysis] Generating rule-based analysis");
  
  const text = ocrText.toLowerCase();
  const hasJD = jobDescription && jobDescription.trim().length > 0;
  const jdLower = hasJD ? jobDescription!.toLowerCase() : "";
  
  // Extract basic info
  const emailMatch = ocrText.match(/[\w.-]+@[\w.-]+\.\w+/);
  const phoneMatch = ocrText.match(/\+?[\d\s()-]{10,}/);
  const hasLinkedIn = text.includes("linkedin") || text.includes("linked.in");
  
  // Common technical keywords
  const techKeywords = [
    "javascript", "python", "java", "react", "node", "sql", "aws", "docker",
    "kubernetes", "typescript", "angular", "vue", "mongodb", "postgresql",
    "git", "ci/cd", "agile", "scrum", "api", "rest", "graphql", "microservices"
  ];
  
  // Count keyword matches
  let keywordScore = 0;
  const foundKeywords: string[] = [];
  const missingKeywords: string[] = [];
  
  if (hasJD) {
    // Extract keywords from JD
    const jdKeywords = jdLower.match(/\b[a-z]{3,}\b/g) || [];
    const uniqueJDKeywords = [...new Set(jdKeywords)].filter(k => k.length > 3);
    
    uniqueJDKeywords.slice(0, 20).forEach(keyword => {
      if (text.includes(keyword)) {
        foundKeywords.push(keyword);
        keywordScore += 2;
      } else {
        missingKeywords.push(keyword);
      }
    });
  } else {
    // Use common tech keywords
    techKeywords.forEach(keyword => {
      if (text.includes(keyword)) {
        foundKeywords.push(keyword);
        keywordScore += 1;
      }
    });
  }
  
  // Format scoring
  let formatScore = 20; // Base score
  if (emailMatch) formatScore += 3;
  if (phoneMatch) formatScore += 3;
  if (hasLinkedIn) formatScore += 2;
  if (text.includes("experience") || text.includes("work history")) formatScore += 5;
  if (text.includes("education")) formatScore += 3;
  if (text.includes("skills")) formatScore += 4;
  
  // Completeness scoring
  let completenessScore = 15; // Base score
  const hasMetrics = /\d+%|\$\d+|increased|reduced|improved/i.test(ocrText);
  if (hasMetrics) completenessScore += 10;
  if (ocrText.length > 1000) completenessScore += 5;
  
  // Calculate total score
  const totalScore = Math.min(100, Math.max(0, keywordScore + formatScore + completenessScore));
  
  // Generate analysis
  const analysis = `
### ðŸ¤– ATS Parsing Report

**Parsing Quality: ${formatScore > 25 ? 'Good' : 'Fair'}**

${hasJD ? '**Note:** This is a tailored analysis based on your job description.' : '**Note:** This is a general analysis based on industry standards.'}

**Contact Information:** ${emailMatch && phoneMatch ? 'Complete' : 'Incomplete'}
**Section Headers:** ${text.includes("experience") && text.includes("education") ? 'Present' : 'Some Missing'}

---

### ðŸ“Š Detailed Score Breakdown

**Keywords & Content Match: ${keywordScore}/40 points**
- Found ${foundKeywords.length} relevant keywords
${hasJD ? `- Missing ${missingKeywords.slice(0, 5).join(", ")}` : ''}

**Format & Parseability: ${formatScore}/30 points**
- Contact info: ${emailMatch ? 'âœ“' : 'âœ—'} Email, ${phoneMatch ? 'âœ“' : 'âœ—'} Phone
- LinkedIn: ${hasLinkedIn ? 'âœ“' : 'âœ—'}

**Completeness & Impact: ${completenessScore}/30 points**
- Quantified achievements: ${hasMetrics ? 'Found' : 'Missing'}
- Resume length: ${ocrText.length > 1000 ? 'Adequate' : 'Too short'}

---

### ðŸ”‘ Critical Missing Keywords

${missingKeywords.slice(0, 5).map((kw, i) => `${i + 1}. **${kw}** - Add to relevant sections`).join('\n')}

---

### ðŸ’¡ Pro Tips

1. **Add quantifiable metrics** - Use numbers, percentages, and dollar amounts
2. **Include all contact info** - Email, phone, and LinkedIn URL
3. **Use action verbs** - Led, Architected, Optimized, Increased, etc.

**Note:** This is a fallback analysis. For detailed AI-powered insights, please ensure OpenRouter API is configured.
`;

  return {
    title: "Resume Analysis",
    category: "General",
    score: totalScore,
    scoreBreakdown: {
      keywords: keywordScore,
      format: formatScore,
      completeness: completenessScore
    },
    missingKeywords: missingKeywords.slice(0, 10).map(kw => ({
      keyword: kw,
      priority: "important",
      section: "Experience",
      context: `Consider adding "${kw}" to relevant sections`,
      frequency: 1,
      impact: 5,
      synonyms: []
    })),
    formatIssues: [
      ...(emailMatch ? [] : [{
        issue: "Missing email address",
        severity: "high",
        fix: "Add a professional email address at the top of your resume",
        location: "Header",
        atsImpact: "ATS cannot contact you without email"
      }]),
      ...(phoneMatch ? [] : [{
        issue: "Missing phone number",
        severity: "medium",
        fix: "Add your phone number in the header",
        location: "Header",
        atsImpact: "Reduces contact options for recruiters"
      }])
    ],
    metricSuggestions: [],
    analysis
  };
}