import { action } from "../_generated/server";
import { v } from "convex/values";
import { callOpenRouter } from "./apiClient";

export const getCurrentUser = async (ctx: any) => {
  const identity = await ctx.auth.getUserIdentity();
  if (!identity) {
    return null;
  }
  
  const user = await ctx.db
    .query("users")
    .withIndex("by_token", (q: any) => q.eq("tokenIdentifier", identity.subject))
    .unique();

  return {
    _id: identity.subject, // Use the subject (Clerk ID) as the ID for auth checks
    dbUser: user, // Return the actual DB user doc if it exists
    ...identity,
  };
};

export const getUserInternal = internalQuery({
  args: { subject: v.string() },
  handler: async (ctx, args) => {
    const user = await getCurrentUser(ctx);
    if (!user || !user.dbUser) throw new Error("Unauthorized");
    const dbUser = user.dbUser;

    // ENFORCEMENT
    const hasActiveSprint = dbUser.sprintExpiresAt && dbUser.sprintExpiresAt > Date.now();
    if (!hasActiveSprint && dbUser.subscriptionTier !== "interview_sprint") {
        throw new Error("PLAN_RESTRICTION: Upgrade to Interview Sprint to track applications.");
    }
    
    // Use identity.subject for querying (consistent with resume creation)
    const identity = await ctx.auth.getUserIdentity();
    const hasActiveSprint = dbUser.sprintExpiresAt && dbUser.sprintExpiresAt > Date.now();
    if (!hasActiveSprint && !isFreeRescan && user.subscriptionTier === "free") {
      throw new Error("PLAN_RESTRICTION: Upgrade to Interview Sprint to track applications.");
    }
    return {
      _id: identity.subject, 
      dbUser: user, 
      ...identity,
    };
  },
});

export const getResumes = internalQuery({
  args: { userId: v.string() },
  handler: async (ctx, args) => {
    const userId = args.userId;
    const user = await getCurrentUser(ctx);
    if (!user || !user.dbUser) throw new Error("Unauthorized");
    const dbUser = user.dbUser;

    const results = await ctx.db
      .query("resumes")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .order("desc")
      .take(50);
    
    // Redact sensitive analysis details for locked resumes
    const redactedResults = results.map(resume => {
      if (!resume.detailsUnlocked) {
        return {
          ...resume,
          // Preview Mode: Show top 2 items for free/locked users
          missingKeywords: resume.missingKeywords?.slice(0, 2),
          matchedKeywords: resume.matchedKeywords?.slice(0, 2),
          formatIssues: resume.formatIssues?.slice(0, 2),
          // Hide detailed breakdowns
          scoreBreakdown: undefined,
          metricSuggestions: undefined,
          // Keep basic info and score
        };
      }
      return resume;
    });

    console.log("[getResumes] All resumes count:", results.length);
    return redactedResults;
  },
});